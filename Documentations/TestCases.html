<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="pandoc.css" type="text/css" />
</head>
<body>
<h1 id="terminologies">Terminologies</h1>
<table>
<thead>
<tr class="header">
<th>Words</th>
<th>Definitions</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Resource</td>
<td>It can be anything that needs to be protected for example : a picture of a user or an API operation.</td>
</tr>
<tr class="even">
<td>Folder</td>
<td>Resource which can contains one or more resources.</td>
</tr>
<tr class="odd">
<td>File</td>
<td>Unique resource.</td>
</tr>
<tr class="even">
<td>Authorization policy</td>
<td>Can contains one or more security rules and is assigned to one or several resources. It is used by the UMA server to determine if an incoming request can execute the requesting operations (read, write or delete) on a protected resource.</td>
</tr>
<tr class="odd">
<td>Security rule</td>
<td>Belongs to an authorization policy.</td>
</tr>
<tr class="even">
<td>Resource owner</td>
<td>An entity capable of granting access to a protected resource. When the resource owner is a person, it is referred to as an end-user.</td>
</tr>
<tr class="odd">
<td>Scope</td>
<td>List of resources which can be accessed by a client.</td>
</tr>
<tr class="even">
<td>Client</td>
<td>An application making protected resource requests on behalf of the resource owner and with its authorization. The term “client” does not imply any particular implementation characteristics (e.g., whether the application executes on a server, a desktop, or other devices)</td>
</tr>
<tr class="odd">
<td>UMA server</td>
<td>Server which is conformed to the OPENID-RFC <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></td>
</tr>
<tr class="even">
<td>OPENID server</td>
<td>Server which is conformed to the UMA-RFC <a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></td>
</tr>
<tr class="odd">
<td>Requesting Party Token (RPT)</td>
<td>An UMA access token associated with a set of authorization data, used by the client to gain access to protected resources at the UMA server.</td>
</tr>
</tbody>
</table>
<h1 id="benchmark">Benchmark</h1>
<p>The following table lists the differences between our product and others: Lokit, Identity Server, Gluu server and AUTH0. It has been made in “29-08-2016”, if you noticed some differences don’t hesitate to contact-us by email.</p>
<table>
<thead>
<tr class="header">
<th></th>
<th><strong>Lokit</strong></th>
<th><strong>Identity Server</strong></th>
<th><strong>Gluu server</strong></th>
<th><strong>AUTH0</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Authors</td>
<td>Habart Thierry</td>
<td>Brock Allen &amp; Dominick Baier</td>
<td>Gluu</td>
<td>Auth0</td>
</tr>
<tr class="even">
<td>Start date</td>
<td>October 2015</td>
<td>January 2014</td>
<td>March 2014</td>
<td>November 2012</td>
</tr>
<tr class="odd">
<td>Workflow Oauth2.0</td>
</tr>
<tr class="even">
<td>Client credentials</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>Password</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="even">
<td>Refresh token</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>Workflow OpenId</td>
</tr>
<tr class="even">
<td>Implicit</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>Hybrid</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>NOK</td>
</tr>
<tr class="even">
<td>Other OPENID features</td>
</tr>
<tr class="odd">
<td>Register a client (<a href="https://openid.net/specs/openid-connect-registration-1_0.html">RFC</a>)</td>
<td>OK</td>
<td>NOK</td>
<td>OK</td>
<td>NOK</td>
</tr>
<tr class="even">
<td>Sign token (<a href="https://tools.ietf.org/html/draft-ietf-jose-json-web-signature-41">JWS</a>)</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>Encrypt token (<a href="https://tools.ietf.org/html/draft-ietf-jose-json-web-encryption-40">JWE</a>)</td>
<td>OK</td>
<td>NOK</td>
<td>NOK</td>
<td>NOK</td>
</tr>
<tr class="even">
<td>Invalidate session</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>NOK</td>
</tr>
<tr class="odd">
<td>Client authentication methods (<a href="http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication">RFC</a>)</td>
</tr>
<tr class="even">
<td>client_secret_basic</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>client_secret_post</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="even">
<td>client_secret_jwt</td>
<td>OK</td>
<td>NOK</td>
<td>NOK</td>
<td>NOK</td>
</tr>
<tr class="odd">
<td>private_key_jwt</td>
<td>OK</td>
<td>NOK</td>
<td>NOK</td>
<td>NOK</td>
</tr>
<tr class="even">
<td>none</td>
<td>OK</td>
<td>NOK</td>
<td>NOK</td>
<td>NOK</td>
</tr>
<tr class="odd">
<td>Response modes</td>
</tr>
<tr class="even">
<td>Query</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>Fragment</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="even">
<td>Form_post</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>Other parameters</td>
</tr>
<tr class="even">
<td>claims (<a href="http://openid.net/specs/openid-connect-core-1_0.html#ClaimsParameter">RFC</a>)</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>NOK</td>
</tr>
<tr class="odd">
<td>request (<a href="http://openid.net/specs/openid-connect-core-1_0.html#RequestObject">RFC</a>)</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>NOK</td>
</tr>
<tr class="even">
<td>Quality</td>
</tr>
<tr class="odd">
<td>Code coverage</td>
<td>84%</td>
<td>Unknown</td>
<td>Unknown</td>
<td>Unknown</td>
</tr>
<tr class="even">
<td>Nombre UTs</td>
<td>633</td>
<td>Unknown</td>
<td>Unknown</td>
<td>Unknown</td>
</tr>
<tr class="odd">
<td>UMA (<a href="http://openid.net/specs/openid-heart-uma-2015-12-09.html">RFC</a>)</td>
<td></td>
</tr>
<tr class="even">
<td>UMA supported</td>
<td>OK</td>
<td>NOK</td>
<td>OK</td>
<td>NOK</td>
</tr>
<tr class="odd">
<td>UI</td>
</tr>
<tr class="even">
<td>UI exists</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>CRUD opened assets</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="even">
<td>CRUD uma assets</td>
<td>OK</td>
<td>NOK</td>
<td>OK</td>
<td>NOK</td>
</tr>
<tr class="odd">
<td>Resource organized by urls</td>
<td>OK</td>
<td>NOK</td>
<td>NOK</td>
<td>NOK</td>
</tr>
<tr class="even">
<td>Enable or disable external identity providers</td>
<td>OK</td>
<td>NOK</td>
<td>OK</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>Deployments</td>
</tr>
<tr class="even">
<td>Deployment methods</td>
<td>Docker or manually</td>
<td>Manually</td>
<td>Manually</td>
<td>Manually or hosted on the cloud</td>
</tr>
<tr class="odd">
<td>Others</td>
</tr>
<tr class="even">
<td>Number of OPENID certifications</td>
<td>5</td>
<td>4</td>
<td>5</td>
<td>2</td>
</tr>
<tr class="odd">
<td>Preferred languages</td>
<td>C#</td>
<td>C#</td>
<td>Java</td>
<td>No preference</td>
</tr>
<tr class="even">
<td>Tools or methods used to easily interact with APIs</td>
<td>Visual Studio extensions and nugget packages</td>
<td>Nuget packages</td>
<td>Unknown</td>
<td>Unknown</td>
</tr>
</tbody>
</table>
<h1 id="architecture">Architecture</h1>
<p>The schema below shows the interactions between components.</p>
<p>On a total of 11 components, there are 5 APIs, one visual studio extension, one website and four databases :</p>
<ul>
<li><p><em>Manager API</em> : used by the clients to execute CRUD operations on OPENID assets for examples : client or resource owners.</p></li>
<li><p><em>OpenId et UMA API</em> : They are conformed to the RFCs OPENID and UMA.</p></li>
<li><p><em>Configuration API</em> : used by the clients to manage the OpenId API configuration for example : enable or disable external identity providers.</p></li>
<li><p><em>WebSite API</em> : an abstract layer which assigns Uris to resources.</p></li>
<li><p><em>WebSite </em>: it is used by an administrator to manage resource access.</p></li>
<li><p><em>Visual studio extension</em> : used by a .NET developer to easily interact with the different components in code.</p></li>
</ul>
<p>The website is used by the administrator to manage the UMA and OPENID assets. Whereas the visual studio extension will be used by developers to access / protect resources such as API operations.</p>
<p>Use cases of both roles have been identified and they are described in the two next chapters.</p>
<h1 id="use-cases-of-the-website">Use cases of the website</h1>
<h2 id="protect-resources">Protect resources</h2>
<h3 id="action-move-resources-to-sub-directory">Action: Move resources to sub directory</h3>
<p>Select one or more resources and click on the item “<img src="media/image1.png" width="123" height="18" />” displayed in the context menu. Selected resources will be moved to a new sub directory.</p>
<h3 id="action-remove-one-or-more-resources">Action: Remove one or more resources</h3>
<p>Select some resources and execute one of the following actions :</p>
<ul>
<li><p>Keyboard Shortcut : DEL</p></li>
<li><p>Action <em>Delete</em> in the contextual menu <img src="media/image2.png" width="17" height="18" /></p></li>
</ul>
<h3 id="action-rename-a-resource">Action: Rename a resource</h3>
<p>A resource can be renamed by executing one of the following actions:</p>
<ul>
<li><p>Keyboard Shortcut : F2</p></li>
<li><p>Action <em>Rename</em> in in the contextual menu <img src="media/image3.png" width="19" height="18" /></p></li>
</ul>
<h3 id="action-move-resources">Action: Move resources</h3>
<p>Select several resources and drag &amp; drop them into an existing folder. A special icon will be displayed in the bottom-right left corner.</p>
<p><img src="media/image4.png" width="127" height="96" /></p>
<h3 id="action-duplicate-one-or-more-resources">Action: Duplicate one or more resources</h3>
<p>Select a resource and duplicate it by executing one of the actions :</p>
<ul>
<li><p>Display the context menu and click on the actions <em>copy</em> &amp; <em>paste</em> or <em>duplicate</em>.</p></li>
</ul>
<p><img src="media/image5.png" width="148" height="92" /></p>
<ul>
<li><p>Use the shortcuts “CTRL+C &amp; CTRL+V“.</p></li>
</ul>
<h3 id="action-how-to-access-to-a-resource">Action: How to access to a resource</h3>
<p>Select a resource and display its contextual menu. When the option “<em>how to access?</em>” is selected then a new window is displayed in front of the file explorer.</p>
<p><img src="media/image6.png" width="388" height="72" /></p>
<h3 id="action-create-a-file">Action: Create a file</h3>
<p>Display the contextual menu of your current working directory and click on the option <em>new file</em> <img src="media/image7.png" width="23" height="22" />.</p>
<h3 id="action-create-a-folder">Action: Create a folder</h3>
<p>Do the same than before but instead of clicking on <em>new file</em> select the action <em>new folder</em> <img src="media/image8.png" width="19" height="22" />.</p>
<h3 id="action-upload-one-or-more-resources">Action: Upload one or more resources</h3>
<p>Resources can be uploaded via different ways:</p>
<ul>
<li><p>Open a windows explorer and select several files, drag and drop them to the page “Protect your resources”.</p></li>
<li><p>Click on the option upload files displayed in the contextual menu</p></li>
</ul>
<p><img src="media/image9.png" width="202" height="100" /></p>
<h3 id="action-refresh-current-working-directory">Action: Refresh current working directory</h3>
<p>Either press F5 or click on the action <em>reload</em> in the contextual menu <img src="media/image10.png" width="120" height="22" /></p>
<h3 id="action-display-keyboard-shortcuts">Action: Display keyboard shortcuts</h3>
<p>List of shortcuts can be displayed by pressing F1.</p>
<p><img src="media/image11.png" width="324" height="218" /></p>
<h3 id="action-change-visualization">Action: Change visualization</h3>
<p>You can choose between vertical or horizontal resources visualization, to do that click on the icon <img src="media/image12.png" width="21" height="19" /> displayed in the menu bar.</p>
<h3 id="action-search-resources-in-the-current-working-directory">Action  Search resources in the current working directory</h3>
<p>Accessible by pressing the keyboard shortcut CTRL+F or by typing your text in the search bar positioned at the top right-hand corner of the window.</p>
<p><img src="media/image13.png" width="576" height="22" /></p>
<h3 id="action-navigate-to-the-previous-next-folder">Action: Navigate to the previous / next folder</h3>
<p>The navigation history is stored into your browser. Navigating to the previous / next folder can be done by executing one of the following actions :</p>
<ul>
<li><p>Use the buttons <img src="media/image14.png" width="35" height="17" /> displayed in the search bar</p></li>
<li><p>Keyboard shortcut <em>Back</em> or <em>CTRL+←</em> : navigate to the previous folder</p></li>
<li><p>Keyboard shortcut <em>CTRL+→</em> : navigate to the next folder.</p></li>
</ul>
<h3 id="action-add-edit-authorization-rules">Action: Add / Edit authorization rules</h3>
<p>If a resource is selected then it’s possible to add or edit its authorization rules. Click on the icon <img src="media/image15.png" width="18" height="18" /> or press the keyboard shortcut <em>CTRL+P</em>.</p>
<p>Rules and authorization policy were mentioned several times but they have never been clearly explained properly.</p>
<p>An authorization policy must contains at least one rule otherwise an error is displayed when attempting to create an empty one. They are used by the UMA server during the authorization process. Indeed when a client wants to access to a protected resource, he asked to the UMA resource an RPT token. The server internally decides to grant client access to a protected resource by executing the policy. The workflow is described in UMA website <a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a>.</p>
<p>Rules are exclusive and if at least one of them is satisfied then authorization is granted by the policy. Here the authorization policy formula is : <span class="math inline"><em>p</em><em>o</em><em>l</em><em>i</em><em>c</em><em>y</em>  = <em>r</em><em>u</em><em>l</em><em>e</em>1  ∪ <em>r</em><em>u</em><em>l</em><em>e</em>2</span>. A rule is satisfied if the received claims values and / or clients are correct.</p>
<p>Policy structure overview :</p>
<p>In order to help you identifying policy and their rules, you can read the scenario below.</p>
<p><em>Problematic</em> : Only the end-user <em>thabart</em> of the application <em>Sample Client</em> is allowed to <em>view his bank</em> account <em>N°12345</em>.</p>
<p><em>Solution</em> : In the first place the identities should be identified and classified by their nature. There are four important information in the scenario, they are underlined in the text. Thanks to the decision table it was possible to classified them.</p>
<table>
<thead>
<tr class="header">
<th>Question</th>
<th>Nature</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>What is the identity of your resource to protect ?</td>
<td>Resource identifier</td>
</tr>
<tr class="even">
<td>What is the identity of your client ?</td>
<td>Client Identifier</td>
</tr>
<tr class="odd">
<td>Which actions do-you want to perform on the resource ?</td>
<td>Permissions</td>
</tr>
<tr class="even">
<td>Do-you want to restrict access to one or more users ? If yes, which information can be used to identify them ? For example : role or geographical position ?</td>
<td>Claims</td>
</tr>
<tr class="odd">
<td>Can-you identify the nature of your resource ?</td>
<td>Nature</td>
</tr>
</tbody>
</table>
<p>Classified information :</p>
<ul>
<li><p>Resource identifier : N°12345</p></li>
<li><p>Client Id : Sample Client</p></li>
<li><p>Permissions : view / read</p></li>
<li><p>Claims : thabart</p></li>
<li><p>Nature : BankAccount</p></li>
</ul>
<p>When you have finished with the resource classification, you can go to the second step.</p>
<p>A resource needs to be created, first add a “BankAccount” folder into the “resources” directory, it should match with the nature of a resource.</p>
<p>Navigate to the new directory and create a file named “N°12345”, same value as the resource identifier.</p>
<p><img src="media/image16.png" width="262" height="54" /></p>
<p>Finally open the authorization policy editor and add a new rule. Below <em>allowed clients</em> select the authorized clients, in our case the client is “Sample Client”.</p>
<p>Under the sub-title “allowed claims” select “sub” et fill-in the field with “thabart”, then click on “Add” to add the claim into the list.</p>
<p>Persist your policy by clicking on <em>add rule</em> and on <em>save</em>.</p>
<p><img src="media/image17.png" width="348" height="312" /></p>
<p>A red square is displayed around a resource with an authorization policy applied on it.</p>
<p><img src="media/image18.png" width="130" height="89" /></p>
<h3 id="action-select-all-resources">Action : Select all resources</h3>
<p>To select all resources press <em>CTRL+A</em>.</p>
<p>You probably noticed that the actions available in the assets directory have not been described, it will be the object of the next chapter.</p>
<h2 id="edit-uma-openid-assets">Edit UMA &amp; OPENID assets</h2>
<h3 id="action-add-a-client">Action : Add a client</h3>
<p>Open the folder <em>assets &gt;&gt; openid &gt;&gt; clients</em> and display its contextual menu.</p>
<p>Click on <em>add client</em> <img src="media/image19.png" width="117" height="21" /> and fill-in the callback urls separated by a comma.</p>
<p><em>Warning : urls should begin with https</em> <a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a></p>
<h3 id="action-delete-one-or-more-clients">Action : Delete one or more clients</h3>
<p>Select several clients, display the contextual menu and click on <em>remove client</em></p>
<p><img src="media/image20.png" width="154" height="24" />.</p>
<h3 id="action-edit-a-client">Action : Edit a client</h3>
<p>Display the client information by clicking on <em>client information</em> <img src="media/image21.png" width="137" height="19" /> option in the contextual menu.</p>
<p><img src="media/image22.png" width="187" height="103" /></p>
<p>The client identity, secret and its callback urls are displayed on the new window.</p>
<p>Click on the link <em>Edit</em> to edit them.</p>
<p><img src="media/image23.png" width="418" height="440" /></p>
<p>The parameters are explained in the OPENID RFC <a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a>.</p>
<p>In most of the cases, advanced parameters don’t need to be updated except if you want to change the workflows. Here some uncommon scenarios in which advanced settings need to be updated:</p>
<ul>
<li><p>The client have a JWKS url, it is used by the OPENID server to decrypt and / or check the signature of the <em>request</em> <a href="#fn6" class="footnoteRef" id="fnref6"><sup>6</sup></a> parameter.</p></li>
<li><p>Update the client authentication method.</p></li>
<li><p>Change information displayed in the consent view.</p></li>
</ul>
<p>If you want more information about the other advanced settings, you can contact-us or read the OPENID documentation<a href="#fn7" class="footnoteRef" id="fnref7"><sup>7</sup></a>.</p>
<h3 id="action-delete-one-or-more-scopes">Action : Delete one or more scopes</h3>
<p>Open the directory <em>assets&gt;&gt;openid&gt;&gt;scopes</em>, select several scopes, display the context menu and click on remove scope <img src="media/image24.png" width="142" height="21" />.</p>
<h3 id="action-display-scope-information">Action : Display scope information</h3>
<p>Select one scope, open its contextual menu and click on <em>scope information</em> <img src="media/image25.png" width="136" height="18" />. The following information are displayed :</p>
<ul>
<li><p>Nature : Is-it an openid scope?</p></li>
<li><p>Visibility : Is-it visible in the consent screen ?</p></li>
<li><p>Contract : Is-is returned by the openid configuration endpoint <em>/.well-known/openid-configuration</em>.</p></li>
</ul>
<h3 id="action-delete-one-or-more-resource-owners">Action : Delete one or more resource owners</h3>
<p>Select some resource owners, display the context menu and click on remove resource owner <img src="media/image26.png" width="177" height="22" />.</p>
<h3 id="action-edit-a-resource-owner">Action : Edit a resource owner</h3>
<p>Select a resource owner, display its context menu and click on <em>resource owner info</em> button <img src="media/image27.png" width="184" height="24" />.</p>
<p>In the new window displayed in front, roles can be assigned to the resource owner. To do that, a local account needs to be created otherwise the message “not a local account” is displayed.</p>
<p>Why is-it useful to add roles ? Sometime it’s difficult to make an authorization policy based on the claims returned by external identity providers. If you want to limit the access of a resource only to certain roles but the claims are coming from facebook, the solution cannot be implemented simply because roles are not returned. But thanks to the website, claims returned by facebook can be enriched with roles. If we replace facebook by ADFS, additional roles don’t need to be specified because they are already returned.</p>
<p>Enrichment workflow :</p>
<p>As we mentioned earlier a resource owner account can have two states :</p>
<p>When a resource owner is authenticated against one of the external identity providers : « Twitter », « Hotmail » or « GitHub » then an external account is automatically created.</p>
<p><img src="media/image28.png" width="273" height="106" /></p>
<p>To switch to a local account, click on the link <em>create a local account</em>:</p>
<p><img src="media/image29.png" width="375" height="259" /></p>
<h3 id="action-delete-one-or-more-authorization-policies">Action: Delete one or more authorization policies</h3>
<p>Open the folder <em>assets&gt;&gt;uma&gt;&gt;authorization policies</em>, select several authorization policies, display the context menu and click on <em>remove authorization policy</em> <img src="media/image30.png" width="196" height="24" />.</p>
<h3 id="action-display-authorization-policy">Action: Display authorization policy</h3>
<p>Select an authorization policy, display its contextual menu and click on <em>authorization policy</em> <img src="media/image31.png" width="187" height="21" />. List of resources impacted by the policy and number of rules are displayed in the window.</p>
<p><img src="media/image32.png" width="329" height="103" /></p>
<h3 id="action-delete-one-or-more-uma-resources">Action: Delete one or more UMA resources</h3>
<p>Open the folder <em>assets&gt;&gt;uma&gt;&gt;resources</em>, select one or more resources, display the contextual menu and click on <em>remove resource</em> <img src="media/image33.png" width="149" height="21" />.</p>
<h3 id="action-display-uma-resource">Action: Display UMA resource</h3>
<p>Display the contextual menu and click on resource info <img src="media/image34.png" width="139" height="24" />. Scopes and resource are displayed in the window :</p>
<p><img src="media/image35.png" width="168" height="106" /></p>
<h2 id="identity-providers">Identity providers</h2>
<p>In the OpenId server, the end user can choose between one of the identity provider to authenticate himself: Hotmail, ADFS, GitHub or the Belgium id card.</p>
<p>When the claims are returned, they are used by the authorization policies to grant a request access to a protected resource.</p>
<p>If some claims are missing in the result, it’s always possible to enrich them with roles (refer to the chapter “edit a resource owner”).</p>
<p>List of actions available in the “connections” screen:</p>
<p>The following providers are configured by default: Microsoft, Linkedin, Google, GitHub, Facebook and the Belgium id card.</p>
<h3 id="action-display-providers">Action: Display providers</h3>
<p>Click on the connections tab to display the providers.</p>
<p><img src="media/image36.png" width="432" height="122" /></p>
<h3 id="action-enable-disable-a-provider">Action  Enable / disable a provider</h3>
<p>Providers can be enabled / disabled from the authentication page. To do that click on the button “On / Off” next to each provider.</p>
<p>By default an authentication page looks like:</p>
<p><img src="media/image37.png" width="233" height="134" /></p>
<p>New authentication page after the Facebook provider has been disabled:</p>
<p><img src="media/image38.png" width="245" height="153" /></p>
<p>Providers are managed by the administrator without worrying about restarting application.</p>
<h3 id="action-add-a-provider">Action: Add a provider</h3>
<p>Click on the <em>new identity provider</em> button to add a new one. When the window is displayed, try to fill-in all the fields. Use the decision table below to find all the values. When you have finished with it, click on the button <em>create</em> to persist the new provider.</p>
<table>
<thead>
<tr class="header">
<th>Fields</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Name</td>
<td>Name displayed is the authentication page</td>
</tr>
<tr class="even">
<td>Callback path</td>
<td>Technical data used by the OPENID server. The value should start with « /signin-* » otherwise there is no button displayed</td>
</tr>
<tr class="odd">
<td>Choose an identity provider type</td>
<td>Choose between OPENID, OAUTH2.0 or WS-Federation</td>
</tr>
</tbody>
</table>
<p>If there is no corresponding identity provider type, you can submit a new “enhancement” ticket to our website. The feature will be developed and deployed to your environment via Docker or XCOPY (refer to the Installation chapter)</p>
<p>If you want to use the resource owners which are stored in your database. We can help you writing some scripts to migrate from the old schema to the new one or create a new OPENID identity provider which takes your database as source.</p>
<h3 id="action-edit-provider">Action: Edit provider</h3>
<p>Click on the provider title to edit it. You will be redirected to a new window where all the parameters are displayed. You will probably notice some differences between types, they are listed in the table:</p>
<table>
<thead>
<tr class="header">
<th>Type</th>
<th>Parameters</th>
<th>Options</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>OAUTH2.0</td>
<td>Callback path</td>
<td>TokenEndpoint</td>
</tr>
<tr class="even">
<td></td>
<td>Namespace</td>
<td>AuthorizationEndpoint</td>
</tr>
<tr class="odd">
<td></td>
<td>Class</td>
<td>Scope</td>
</tr>
<tr class="even">
<td></td>
<td>Code</td>
<td>ClientId</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>UserInformationEndpoint</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>ClientSecret</td>
</tr>
<tr class="odd">
<td>OPENID</td>
<td>Callback path</td>
<td>ClientId</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>Scope</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>ClientSecret</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>WellKnownConfigurationEndPoint</td>
</tr>
<tr class="odd">
<td>WSFEDERATION</td>
<td>Callback path</td>
<td>Realm</td>
</tr>
<tr class="even">
<td></td>
<td>Namespace</td>
<td>IdEndpoint</td>
</tr>
<tr class="odd">
<td></td>
<td>Class</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>Code</td>
<td></td>
</tr>
</tbody>
</table>
<p>All parameters except namespace, code and class can be deduced with the configuration of your external identity providers for examples: the client identifier or secret. Those specific parameters are used by the OPENID server to parse xml or json and returns OPENID claims.</p>
<p>Those specific settings are not present in OPENID for a very simple reason, because a parser is not needed when OPENID is correctly implemented. The complete list of applications compliant with the standard is available online <a href="#fn8" class="footnoteRef" id="fnref8"><sup>8</sup></a> .</p>
<p>The parameter “code” presents in OAUTH2.0 and WS-Federation should contains a class with a method that respects a certain signature:</p>
<p>When the code has been written, the fields namespace and class name can be filled-in with their corresponding values. If we have the code below then the namespace is “Parser” and class name is “Example” :</p>
<h2 id="parameters">Parameters</h2>
<p>Parameters are accessible via the “settings” tab. The token / authorization code expiration times can be updated.</p>
<p><img src="media/image39.png" width="369" height="92" /></p>
<h1 id="use-cases-of-the-visual-studio-extension"><br />
Use cases of the Visual Studio extension</h1>
<p>The extension is working only with Visual Studio version 2015. The previous versions will be supported in future release.</p>
<h2 id="configure-parameters">Configure parameters</h2>
<p>The configuration window is accessible via “Tools &gt;&gt; Options &gt;&gt; SimpleIdentityServer”. There are two URLs, the first one is used by the “generate resource” feature to generate a resource for each selected actions.</p>
<p>The other url is mostly used to retrieve an access token via client credentials, it is passed in the Authorization header to access to protected operations.</p>
<p><img src="media/image40.png" width="576" height="220" /></p>
<h2 id="generate-one-or-more-resources">Generate one or more resources</h2>
<p>Choose any API project for which you want to protect its operations and display its contextual menu, then click on the option <em>generate resource</em> <img src="media/image41.png" width="137" height="22" /></p>
<p>Don’t worry if it takes some times to load the operations. If after a while they are not displayed then close the panel window, select the project and reopen it again.</p>
<p>Here some features available in the window:</p>
<h3 id="refresh-the-resources">Refresh the resources</h3>
<p>To refresh the resources, just click on the button <em>refresh</em>. It will take some times before they are displayed.</p>
<p><img src="media/image42.png" width="253" height="253" /></p>
<h3 id="protect-one-or-more-resources">Protect one or more resources</h3>
<p>Select the resources that you wish to protect and indicate the API version. It’s very important to mention it because several versions of the same API can be deployed and they can present different contracts. The number should be incremented if there are any breaking changes with the previous version.</p>
<p>When the form has been filled-in then click on the button <em>protect</em> to protect the resources.</p>
<p>Behind the scene the following sub-tasks are performed :</p>
<ul>
<li><p>Create a resource by following a naming convention : “<em>Api\&lt;assembly name&gt;\&lt;version number&gt;\&lt;controller name&gt;\&lt;action&gt;</em>”</p></li>
<li><p>Add Nuget packages : “SimpleIdentityServer.UmaIntrospection.Authentication” and “SimpleIdentityServer.Uma.Authorization”</p></li>
<li><p>Add a test file “Startup_Sample.cs”, it can be reused to protect the operations.</p></li>
</ul>
<p><img src="media/image43.png" width="341" height="123" /></p>
<p>Technical details are described in the « technical documentation »».</p>
<h2 id="generate-security-proxy">Generate security proxy</h2>
<p>An application / client who wants to access to protected resources, needs to retrieve an RPT token first and passes it to the Authorization request header. To do that the option <em>generate security proxy</em> can be used by the developer.</p>
<p>The following actions are available in the window:</p>
<h3 id="action-search-one-or-more-resources">Action : Search one or more resources</h3>
<p>Type the name in the search bar and click on “search” to confirm.</p>
<p><img src="media/image44.png" width="206" height="204" /></p>
<h3 id="action-add-a-security-proxy">Action : Add a security proxy</h3>
<p>Select one resource and click on <em>Add</em>. The following sub-tasks are performed :</p>
<ul>
<li><p>Install the Nuget package : “SimpleIdentityServer.Proxy”</p></li>
<li><p>Add files to the selected project :</p>
<ul>
<li><p>SecurityProxy_*.cs : contains a static method which can be used to retrieve an RPT token</p></li>
<li><p>AuthProvider.cs : can be used to retrieve an identity token via resource owner credentials</p></li>
<li></li>
</ul></li>
</ul>
<h1 id="scenarios">Scenarios</h1>
<p>In this chapter we will focus on the most common problems in enterprise, and we will try to solve them.</p>
<p>Samples can be found here :</p>
<p><em>https://github.com/thabart/SimpleIdentityServer.Samples.git</em></p>
<h2 id="first-scenario-an-heavy-application-wants-to-access-to-a-protected-api">First scenario: An heavy application wants to access to a protected API</h2>
<p><strong>Context</strong> An e-commerce enterprise has internally developed a tool used by his marketing team, to retrieve information about his most loyal clients.</p>
<p>The application has been developed in WPF and interact with a RESTFUL API to retrieve the clients. <em>Only this application and users that belong to the “marketing” group are authorized to retrieve the list</em>.</p>
<p><strong>Problem</strong>: How the application can access to the protected operation?</p>
<p><strong>Solution</strong>:</p>
<p>The workflow is made of three big steps:</p>
<ul>
<li><p>Identity token: retrieve an identity token with implicit grant-type <a href="#fn9" class="footnoteRef" id="fnref9"><sup>9</sup></a>. The token is returned to the client in a callback parameter.</p></li>
<li><p><em>RPT token</em> The identity and access token (valid for the scope uma_authorization) are passed in the request to retrieve the RPT one <a href="#fn10" class="footnoteRef" id="fnref10"><sup>10</sup></a>. When it is received by the WPF application, the token is passed in the Authorization header to retrieve the loyal clients. Both parameters are required by the authorization policy.</p></li>
<li><p><em>Check RPT token</em>: The token is checked against the introspection endpoint <a href="#fn11" class="footnoteRef" id="fnref11"><sup>11</sup></a>, this endpoint is offered by the UMA server.</p></li>
</ul>
<p>We spared you the implementation details, otherwise it will be too much difficult to understand. The workflow is normally much more complex and contains more intermediate steps.</p>
<p>Before going further, we are going to prepare the environment by following the steps:</p>
<h3 id="identify-and-classify-identities">Identify and classify identities</h3>
<p>The decision table can help you identify and classify them.</p>
<table>
<thead>
<tr class="header">
<th>Questions</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Which application wants to access to the resource ?</td>
<td>Client</td>
</tr>
<tr class="even">
<td>Which operation do-you want to protected ? Identify the service name, his version, the business entity (client, product) et operation.</td>
<td>Resource : Concatenation of service name, version number, business entity and operation.</td>
</tr>
<tr class="odd">
<td>Which applications are authorized to access ?</td>
<td>Authorized clients</td>
</tr>
<tr class="even">
<td>Which resource owner informations are accepted ?</td>
<td>Claims</td>
</tr>
</tbody>
</table>
<p>Result:</p>
<ul>
<li><p>Client: WPF application</p></li>
<li><p>Resource  ClientApi / v1 / Clients / Get</p></li>
<li><p>Authorized clients : WPF application</p></li>
<li><p>Claims : role marketing.</p></li>
</ul>
<p>When you have finished, the identities can be added.</p>
<h3 id="add-a-client">Add a client</h3>
<p>Add a new client and edit his properties (for more information refer to the use cases “add a client” and “edit a client”). In the new window update as many properties as you can. There are parameters very easy to update like the displayed name and callback urls, however some of them are not obvious. Try to guess the grant-types value, they are needed by the client to interact with the other components. If you succeed, then other values can be easily deduced.</p>
<p>The better way to choose grant-types is by identifying all interactions with the OPENID server. Only one interaction has been identified in the workflow. An identity and access token (valids for the scopes “uma_protection” and “uma_authorization”) are returned to the client. Keep in mind that whatever the situation, when a client is trying to retrieve an RPT token, an access token valids for both scopes should be retrieved.</p>
<p>Depending on the technical implementation of the client, the grant-type can be different. Relationships between implementation type and grant-types are listed:</p>
<table>
<thead>
<tr class="header">
<th>Implementation</th>
<th>Grant-Type</th>
<th>Advantages</th>
<th>Disadvantages</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Embedded browser</td>
<td>implicit</td>
<td>Authentication is delegated to OPENID</td>
<td>No control over the look and feel</td>
</tr>
<tr class="even">
<td>Create formula</td>
<td>client_credentials</td>
<td>Control look and feel</td>
<td><p>The code must be obfuscated, because the client identifier and secret must be hidden from malicious users.</p>
<p>Don’t choose this approach if there is no trust relationship between the client and server.</p></td>
</tr>
</tbody>
</table>
<p>When you have the grant-types then the other parameters can be deduced. Just answer the questions of the next two tables:</p>
<table>
<thead>
<tr class="header">
<th>Grant type</th>
<th>Response types</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Authorization code</td>
<td>Authorization code</td>
</tr>
<tr class="even">
<td>Implicit flow</td>
<td>Token</td>
</tr>
<tr class="odd">
<td></td>
<td>Authorization code</td>
</tr>
<tr class="even">
<td></td>
<td>Identity token</td>
</tr>
<tr class="odd">
<td>Client credentials</td>
<td></td>
</tr>
<tr class="even">
<td>Password</td>
<td></td>
</tr>
<tr class="odd">
<td>Refresh token</td>
<td></td>
</tr>
</tbody>
</table>
<p><em>Mappings between grant-types and response-types</em></p>
<table>
<thead>
<tr class="header">
<th>Type token</th>
<th>Scopes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RPT token</td>
<td>uma_authorization</td>
</tr>
<tr class="even">
<td></td>
<td>uma_protection</td>
</tr>
<tr class="odd">
<td>Identity token</td>
<td>Openid</td>
</tr>
<tr class="even">
<td></td>
<td>Profile</td>
</tr>
<tr class="odd">
<td></td>
<td>Role</td>
</tr>
<tr class="even">
<td></td>
<td><em>Complete list can be found in the documentation</em> <a href="#fn12" class="footnoteRef" id="fnref12"><sup>12</sup></a></td>
</tr>
</tbody>
</table>
<p><em>Mappings between tokens and scopes</em></p>
<p>When all the parameters have been found, the edit page can be filled-in:</p>
<ul>
<li><p>Callback uris : <a href="https://client.com" class="uri">https://client.com</a></p></li>
<li><p>Grant types  implicit</p></li>
<li><p>Response types: token, id_token</p></li>
<li><p>Scopes: openid, profile, role, uma_authorization, uma_protection</p></li>
</ul>
<p><img src="media/image45.png" width="319" height="365" /></p>
<h3 id="add-a-resource">Add a resource</h3>
<p>There are different two ways to add a resource, either with the website (refer to the use case “create a folder”) or either with the Visual Studio extension (refer to the use case “generate one or more resources”). In both cases, the name must respect a certain convention which has been decided by you and it must be consistent with the other resources. For example, imagine there are two pictures, one “Thierry\picture.png” and an another “Lokit \ picture.png”. At first glance this organisation seems to be awkward, and it can be easily reorganized in something cleaner: “images\thierry-picture.png &amp; images\lokit-picture.png”.</p>
<p>If your resource is an API operation, then we suggest to respect this convention: “<em>Apis \ &lt;application name&gt; \ &lt;version number&gt; \ &lt;business entity&gt; \ &lt;operation&gt;</em>”</p>
<p>In our scenario the resource name is: « <em>Apis \ ClientApi \ v1 \ ClientsController \ Get</em> ». If you are working with the Visual Studio Extension you don’t have to be worried about the name because the convention is respected.</p>
<p>We really insist on the fact that it’s very important to have a good architecture since the beginning. If later the structure is modified, then all the resource consumers will be impacted and they must be updated and redeployed again.</p>
<h3 id="add-authorization-policy">Add authorization policy</h3>
<p>When the client and resource have been created then the authorization policy can be assigned. If you encounter some difficulties to identity clients and claims, you can always refer to the use case “Add / Edit authorization rules”.</p>
<ul>
<li><p>Allowed clients: WpfClient</p></li>
<li><p>Allowed claims: role marketing</p></li>
<li><p>Permissions: execute</p></li>
</ul>
<p><img src="media/image46.png" width="265" height="240" /></p>
<h3 id="assign-marketing-role-to-the-resource-owner">Assign marketing role to the resource owner</h3>
<p>The marketing role have to be assigned to the resource owner, otherwise the authorization policy will never pass. Choose a resource owner, edit his properties and assign the role.</p>
<p><img src="media/image47.png" width="319" height="140" /></p>
<h3 id="develop">Develop</h3>
<p>When you have finished with the initial setup, you can start to implement the changes.</p>
<h4 id="api">API</h4>
<p>There are two different kinds of authorization policies:</p>
<ul>
<li><p><em>Conventional</em>: the URL of the resource must match the structure of the project and also the API version. The last value can be set to the property “ConventionalUmaOptions.Version”.</p></li>
<li><p><em>Individual</em>: limit the access to one specific resource by passing the URL and scopes.</p></li>
</ul>
<p>The technical implementation is running only on ASP.NET CORE projects. If you are working on a previous version, we can help you with the implementation.</p>
<p>Previous versions will be supported in future release.</p>
<p>The Nuget packages</p>
<p>« <em>SimpleIdentityServer.UmaIntrospection.Authentication</em> » and « <em>SimpleIdentityServer.Uma.Authorization</em> »  must be installed on your API project.</p>
<p>Enabling the conventional authorization is pretty simple. Insert the code below into the method “ConfigurationServices” of the Startup class.</p>
<p>L’opération « ClientController/Get » doit ensuite être décorée par l’attribut : <img src="media/image48.png" width="133" height="18" /></p>
<h4 id="wpf-application">WPF application</h4>
<p>In first place, add the Nuget package “SimpleIdentityServer.Proxy” to your client. You need it get an RPT token to retrieve the list of clients.</p>
<p>An authentication window must be displayed by your application. There are two different ways to do it, either by displaying the OPENID authentication webpage inside an embedded browser or with a WPF formula. Whatever the methodology you have chosen, at the end the identity and access tokens must be retrieved and stored.</p>
<p>Our preference of course is to use an embedded browser, because we don’t trust the OPENID server.</p>
<p>The following code is used to retrieve an RPT token. Don’t forget to update the properties like UmaConfigurationUrl, OpenIdConfigurationUrl and RootManagerApiUrl.</p>
<p>Invoke the method GetRptToken and pass the tokens as parameters. When the RPT is received, it can be passed to the authorization header.</p>
<p>If you want to launch the application, open the solution “Scenario1 \ WpfClient” from the repository “SimpleIdentityServer.Samples”. Open the two files ”UI\WpfClient\SecurityProxyClientApi”, “UI\WpfClient\Constants” and update their properties.</p>
<p>Launch the application and enters the credentials of a resource owner with marketing role.</p>
<p><img src="media/image49.png" width="346" height="233" /></p>
<p>If the authentication succeeds, then the list of clients is displayed:</p>
<p><img src="media/image50.png" width="279" height="293" /></p>
<h2 id="second-scenario-an-api-want-to-access-to-a-resource">Second scenario : an API want to access to a resource</h2>
<p><strong>Context</strong>: A new RESTFUL service has been developed to retrieve the most loyal clients. Those data must be enriched with marketing information, they have been gathered by the marketing team since the creation of the enterprise.</p>
<p>At the end consolidated data must be returned by the API. They will be consumed by analytics tools to follow the evolution of client satisfactions.</p>
<p><strong>Problem</strong> : How the API can access to the clients ?</p>
<p><strong>Solution</strong>:</p>
<p>The workflow presents here is very to similar to the one in the first scenario. There is only one difference, the identity token is not returned to the client. The reason is simple, if the client is correct then an RPT token is granted by the UMA server. User information are not needed by the authorization policy then by deduction the identity token doesn’t have to be passed in the request.</p>
<p>The workflow that we are going to follow to implement the solution looks like the one in the previous scenario. The task “assigned marketing role to the resource owner” have been removed.</p>
<h3 id="identify-and-classify-identities-1">Identify and classify identities</h3>
<p>After using the decision table (refer to the previous scenario) we obtained :</p>
<ul>
<li><p>Client : API</p></li>
<li><p>Resource : ClientApi / v1 / Clients / Get</p></li>
<li><p>Authorized clients : API</p></li>
<li><p>Claims : none</p></li>
</ul>
<h3 id="add-a-client-1">Add a client</h3>
<p>Most of the parameters can be easily deduced including the grant-type ! Which grant-type will you choose by taking into account that there is a trust relationship with the OPENID server and there is no identity token ?</p>
<p>The correct answer is … “client_credentials”. Indeed there is no danger to embed the client credentials into the code because the API is hosted in a server, so the code cannot be accessed by malicious users.</p>
<p>Client parameters :</p>
<ul>
<li><p>Grant-types : client credentials</p></li>
<li><p>Scopes : uma_authorization et uma_protection</p></li>
</ul>
<p><img src="media/image51.png" width="273" height="279" /></p>
<h3 id="add-a-resource-1">Add a resource</h3>
<p>The resource already exists (refer to the first scenario).</p>
<h3 id="add-authorization-policy-1">Add authorization policy</h3>
<p>Edit the authorization policy of the resource « resources \ Apis \ ClientApi \ v1 \ ClientsController \ Get » and add a new rule. If you have some doubts about the parameters, we invite you to re-read again the use case « add / edit authorization policy rules ». It’s very important to guess by yourself the parameters, at the beginning it’s difficult but you will quickly take the habit.</p>
<p>Rule parameters :</p>
<ul>
<li><p>Allowed clients : Marketing API</p></li>
<li><p>Allowed claims : empty</p></li>
<li><p>Permissions : execute</p></li>
</ul>
<p><img src="media/image52.png" width="220" height="196" /></p>
<h3 id="develop-1">Develop</h3>
<h4 id="client-api">Client (API)</h4>
<p>Install the Nuget package « SimpleIdentityServer.Proxy » to your client.</p>
<p>Retrieve an access token valids for the scope “uma_protection” and “uma_authorization” by using the grant-type client_credentials.</p>
<p>Invoke the function « GetRptToken » and pass the access token value as parameters (umaProtectionToken and umaAuthorizationToken). The result can be used to retrieve the clients.</p>
<p>If you want to launch the complete example, open the solution « Scenario2 \ MarketingClient » from the repository « SimpleIdentityServer.Samples » and update the properties.</p>
<p>Launch both projects “ClientApi” and “MarketingClient” and browse the URL :</p>
<p><a href="http://localhost:5103/api/ratings" class="uri">http://localhost:5103/api/ratings</a>. The clients will be displayed in the browser.</p>
<p><img src="media/image53.png" width="387" height="76" /></p>
<h2 id="troisième-scénario-limiter-laccès-à-certaines-fonctionnalités-du-site">Troisième scénario : Limiter l’accès à certaines fonctionnalités du site</h2>
<p><strong>Contexte</strong> : Les utilisateurs avec le rôle « administrator » peuvent voir le bouton « administrate » sur le site internet tandis que les autres ne le peuvent pas.</p>
<p><strong>Problème</strong> : Comment limiter l’accès à certaines fonctionnalités selon le rôle des utilisateurs ?</p>
<p><strong>Solution</strong> :</p>
<p>Comparé aux autres scénarios, le workflow présenté ci-dessous est assez simple :</p>
<ul>
<li><p>L’utilisateur s’authentifie auprès du serveur OPENID. Une fois authentifié alors les identity &amp; access tokens sont retournés au site internet.</p></li>
<li><p>Les permissions sont ensuite récupérées du serveur UMA et stockées dans un cookie. Les tokens qui ont été récupérés sont passés en paramètre de la requête.</p></li>
</ul>
<p>Comme les scénarios précédents nous allons suivre une méthodologie afin d’implémenter la solution.</p>
<h3 id="identifier-et-catégoriser-les-entités">Identifier et catégoriser les entités</h3>
<p>Voici les entités que l’obtient après avoir utilisé le tableau de décision :</p>
<ul>
<li><p>Client : WebSite</p></li>
<li><p>Ressources : WebSite \ Scenario3 \ Home \ Admin</p></li>
<li><p>Liste des clients autorisés : WebSite</p></li>
<li><p>Liste des claims : rôle « administrator »</p></li>
</ul>
<h3 id="ajouter-un-client">Ajouter un client</h3>
<p>Une fois de plus les paramètres sont assez faciles à déduire excepté le grant type. Le choix dépend encore une fois de la façon dont vous souhaitez authentifier les utilisateurs finaux. Si votre choix se porte sur le développement d’un formulaire « login » &amp; « mot de passe » alors le grant type choisi sera « password ». Faîtes bien attention si vous choisissez ce grant-type car il est nécessaire d’avoir une relation de confiance avec le fournisseur d’identité et les identifiants du client « Id » &amp; « secret » doivent être cachés du public.</p>
<p>Si au contraire vous souhaitez déléguer cette problématique d’authentification au serveur OPENID, choisissez alors le grant-type « implicit ». Lors de l’authentification l’utilisateur sera redirigé vers le serveur OPENID qui retournera ensuite les tokens. Notre préférence est toujours de choisir le grant-type le plus fiable et facile à implémenter, c’est pour cela que ce dernier a été sélectionné.</p>
<p>Faîtes bien attention de ne pas oublier les scopes obligatoires « uma_authorization » &amp; « uma_protection » car il y a une interaction avec le serveur UMA.</p>
<p>Paramètres du client :</p>
<ul>
<li><p>Callback url : <a href="https://localhost:5105/Authenticate/Callback" class="uri">https://localhost:5105/Authenticate/Callback</a></p></li>
<li><p>Grant types : implicit</p></li>
<li><p>Response types : token &amp; id_token</p></li>
<li><p>Scopes : uma_protection, uma_authorization, role, openid, profile</p></li>
</ul>
<p><img src="media/image54.png" width="351" height="237" /></p>
<h3 id="ajouter-une-ressource">Ajouter une ressource</h3>
<p>Ajouter la ressource « WebSite \ Scenario3 \ Home \ Admin ».</p>
<p><img src="media/image55.png" width="231" height="92" /></p>
<h3 id="ajouter-la-politique-dautorisation">Ajouter la politique d’autorisation</h3>
<p>Ajoutez une politique d’autorisation à la ressource. Essayez encore une fois de deviner les paramètres en vous appuyant sur le contexte ainsi que sur la description du cas d’utilisation : « Ajouter / Editer les règles d’autorisation ».</p>
<ul>
<li><p>Allowed clients : WebApplicationScenario3</p></li>
<li><p>Permissions : read</p></li>
<li><p>Allowed claims : rôle « administrator »</p></li>
</ul>
<p><img src="media/image56.png" width="284" height="255" /></p>
<h3 id="ajouter-le-rôle-administrator-au-resource-owner">Ajouter le rôle « administrator » au resource owner</h3>
<p>. Editez les propriétés du resource owner de votre choix et ajoutez lui le rôle « administrator ».</p>
<p><img src="media/image57.png" width="201" height="145" /></p>
<h3 id="développer">Développer</h3>
<p>Je vous invite à jeter un œil au projet «Scenario3 \ WebApplication » du repository « SimpleIdentityServer.Samples ». Mettez à jour les paramètres du fichier « Constants.cs » et lancez l’application.</p>
<p>Si vous-vous connectez avec un utilisateur qui possède le rôle « administrator » alors la permission « Admin » est affichée, autrement il n’y a que trois permissions.</p>
<p><img src="media/image58.png" width="293" height="195" /></p>
<p>Permissions d’un utilisateur « administrator »</p>
<p><img src="media/image59.png" width="354" height="215" /></p>
<p>Permissions d’un utilisateur non « administrator »</p>
<h1 id="installation">Installation</h1>
<p>Le guide part du principe que l’architecture va être installée sur la même machine. Gardez à l’esprit qu’il est tout à fait possible de déployer séparément les différents composants. Cela peut être utile si souhaitez mettre en place le load balancing, pour plus de précisions référez vous au chapitre « Documentation technique \ Load balancing ».</p>
<h2 id="etapes-obligatoires"><span id="_Toc455497616" class="anchor"><span id="_Toc460958361" class="anchor"></span></span>Etapes obligatoires</h2>
<p>Que vous choisissez d’installer le produit manuellement ou par Docker, il y a quelques prérequis à installer sur votre machine.</p>
<h3 id="installer-git"><span id="_Toc455497617" class="anchor"><span id="_Toc460958362" class="anchor"></span></span>Installer GIT</h3>
<p>GIT doit être installé afin de récupérer les sources du projet, suivez le guide du site officiel : (link)</p>
<p><img src="media/image60.png" width="380" height="157" /></p>
<h3 id="installer-le-certificat"><span id="_Toc455497618" class="anchor"><span id="_Toc460958363" class="anchor"></span></span>Installer le certificat</h3>
<p>Le certificat « LokitCA.cer » joint au produit doit être installé sur votre machine dans « Certificate Store \ Local User \ Trusted CA ». Sans le certificat le site web ne pourra pas interagir avec les APIs.</p>
<p><img src="media/image61.png" width="444" height="142" /></p>
<h2 id="installation-manuelle"><span id="_Toc455497619" class="anchor"><span id="_Toc460958364" class="anchor"></span></span>Installation manuelle</h2>
<p>TODO</p>
<h2 id="installer-avec-docker"><span id="_Toc455497620" class="anchor"><span id="_Toc460958365" class="anchor"></span></span>Installer avec docker</h2>
<h3 id="prérequis"><span id="_Toc455497621" class="anchor"><span id="_Toc460958366" class="anchor"></span></span>Prérequis</h3>
<p>Le produit est déployé sur plusieurs conteneurs Docker. La procédure est assez simple et se résume en quelques étapes. Mais avant de commencer vous devez vous assurer que les prérequis suivants ont bien été installés et configurés sur votre machine.</p>
<h4 id="installer-docker">Installer Docker</h4>
<p>Docker doit être installé, vous pouvez suivre le guide sur le site officiel (<a href="https://docs.docker.com/engine/installation/">lien</a>) qui est très bien expliqué :</p>
<p><img src="media/image62.png" width="420" height="112" /></p>
<h4 id="configurer-virtualbox">Configurer VirtualBox</h4>
<p>Par défaut Docker utilise VirtualBox pour lancer sa machine virtuelle. Des règles de redirection de ports doivent être ajoutées sur la machine « default », sans quoi vous ne pourrez pas naviguer sur le site :</p>
<ul>
<li><p>Ouvrez VirtualBox et sélectionnez la machine « default »</p></li>
<li><p>Cliquez sur « Configuration » puis sélectionnez l’onglet « network »</p></li>
<li><p>Cliquez sur le bouton « port redirection » et assurez-vous de bien avoir les mêmes règles :</p></li>
</ul>
<p><img src="media/image63.png" width="282" height="148" /></p>
<p>Note : Une règle de redirection manque dans la capture d’écran. Ajoutez la sinon les logs ne pourront pas être affichés sur le site :</p>
<p>Nom : Kibana</p>
<p>Protocol : TCP</p>
<p>IP hôte : 127.0.0.1</p>
<p>Port hôte : 5601</p>
<p>Port invité : 5601</p>
<h3 id="lancer-le-déploiement">Lancer le déploiement</h3>
<p>Toujours dans le même invité de commande, exécutez l’instruction « docker-compose up » et attendez que le produit se lance.</p>
<p>Une fois l’application installée et déployée, vous pouvez vous connecter en tant qu’administrateur au site web <a href="http://localhost:4200" class="uri">http://localhost:4200</a>.</p>
<h1 id="documentation-technique">Documentation technique</h1>
<h2 id="monitoring">Monitoring</h2>
<p>Pour observer les événements naviguez sur l’onglet « Logs » du site. Si c’est la première que vous vous y rendez alors configurez un index de recherche avec cette valeur « <em>simpleidserver-*</em> » puis importez le fichier « Kibana-Exports\export.xml ». Le dashboard sera alors configuré et visible à partir du site.</p>
<p><img src="media/image64.png" width="431" height="349" /></p>
<p>La fenêtre est composée de 4 widgets :</p>
<ul>
<li><p>Affiche tous les événements qui ont lieux dans le serveur OPENID</p></li>
<li><p>Suivre l’évolution du nombre de « tokens » qui ont été accordés au fil du temps.</p></li>
<li><p>Voir le nombre d’erreur d’autorisations ainsi qu’un autre widget qui affiche les erreurs d’autorisation.</p></li>
</ul>
<h2 id="nuget-packages">Nuget packages</h2>
<h3 id="simpleidentityserver.proxy">SimpleIdentityServer.Proxy</h3>
<p>Installez le sur votre client afin de pouvoir facilement récupérer un RPT token et l’utiliser pour accéder à une ressource protégée.</p>
<h3 id="simpleidentityserver.umaintrospection.authentication">SimpleIdentityServer.UmaIntrospection.Authentication</h3>
<p>Installez le sur un projet ASP.NET CORE qui contient des ressources sensibles. Il authentifie les requêtes qui ont un RPT token dans l’Authorization header.</p>
<h3 id="simpleidentityserver.uma.authorization">SimpleIdentityServer.Uma.Authorization</h3>
<p>Installez le sur un projet ASP.NET CORE afin de mettre en place la politique d’autorisation.</p>
<h2 id="load-balancing">Load balancing</h2>
<p>Pour mettre en place le load balancing il est nécessaire de déployer les APIs sur différentes machines. Ces derniers peuvent tourner sur n’importe quel OS (Linux, Windows ou MAC) grâce au Framework DOTNET CORE <a href="#fn13" class="footnoteRef" id="fnref13"><sup>13</sup></a>. Choisissez parmi l’une des solutions (ou autre) de load balancing  (HalProxy etc …) et implémentez cette architecture :</p>
<h1 id="reste-à-faire">Reste à faire</h1>
<table>
<thead>
<tr class="header">
<th>Tâche</th>
<th>Priorité</th>
<th>Avancement</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Ajouter un nouveau type de fournisseur d’identité SAML</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="even">
<td>Ajouter le code pour les fournisseurs d’identité OPENID</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="odd">
<td>Afficher le bouton pour créer un fournisseur d’identité externe</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="even">
<td>Ajouter un fournisseur d’identité externe</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="odd">
<td>Afficher le nom de l’utilisateur &amp; son image &amp; un bouton de déconnection</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="even">
<td>Vérifier le rôle de l’utilisateur</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="odd">
<td>Vérifier pourquoi tous les fournisseurs d’identité ne sont pas affichés dans l’application WPF</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="even">
<td>Lorsque le client ne peut pas être authentifié alors retourner un message d’erreur lisible</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="odd">
<td>Modifier le titre « GenerateResourceCommand »</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="even">
<td>Décrire le premier scénario</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="odd">
<td>Afficher les clients</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="even">
<td>Utiliser un seul token pour plusieurs accès</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="odd">
<td>Décrire le second scénario</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="even">
<td>Décrire le troisième scénario</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="odd">
<td>Supprimer la propriété « include sub » de UmaIntrospection</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="even">
<td>Utiliser WS-Federation AUTH0</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="odd">
<td>Ajouter une partie dans le document sur Kibana</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="even">
<td>Ajouter la partie EASY DEPLOYMENT</td>
<td>5</td>
<td>DONE</td>
</tr>
<tr class="odd">
<td>Héberger le site internet</td>
<td>5</td>
<td>TODO</td>
</tr>
<tr class="even">
<td>Déployer la solution sur azure (avec docker)</td>
<td>5</td>
<td>TODO</td>
</tr>
<tr class="odd">
<td>Sécuriser l’API</td>
<td>5</td>
<td>TODO</td>
</tr>
</tbody>
</table>
<p>Afin de créer une machine virtuelle sur Microsoft Azure avec docker d’installé dessus alors lisez la documentation : <a href="https://azure.microsoft.com/fr-fr/documentation/articles/virtual-machines-linux-dockerextension/" class="uri">https://azure.microsoft.com/fr-fr/documentation/articles/virtual-machines-linux-dockerextension/</a></p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>RFC OPENID : http://openid.net/specs/openid-connect-core-1_0.html<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>RFC UMA : https://docs.kantarainitiative.org/uma/rec-uma-core.html<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>RPT token : https://docs.kantarainitiative.org/uma/rec-uma-core.html#rfc.section.3.5.1<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>Redirect_uri validation rules : <a href="https://openid.net/specs/openid-connect-registration-1_0.html#ClientMetadata" class="uri">https://openid.net/specs/openid-connect-registration-1_0.html#ClientMetadata</a><a href="#fnref4">↩</a></p></li>
<li id="fn5"><p>Client parameters : <a href="https://openid.net/specs/openid-connect-registration-1_0.html#ClientMetadata" class="uri">https://openid.net/specs/openid-connect-registration-1_0.html#ClientMetadata</a><a href="#fnref5">↩</a></p></li>
<li id="fn6"><p>Request parameter : <a href="http://openid.net/specs/openid-connect-core-1_0.html#JWTRequests" class="uri">http://openid.net/specs/openid-connect-core-1_0.html#JWTRequests</a><a href="#fnref6">↩</a></p></li>
<li id="fn7"><p>OPENID documentation : <a href="http://openid.net/specs/openid-connect-core-1_0.html" class="uri">http://openid.net/specs/openid-connect-core-1_0.html</a><a href="#fnref7">↩</a></p></li>
<li id="fn8"><p>Applications compliants with OPENID : http://openid.net/certification/<a href="#fnref8">↩</a></p></li>
<li id="fn9"><p>Implicit grant type : http://openid.net/specs/openid-connect-implicit-1_0.html<a href="#fnref9">↩</a></p></li>
<li id="fn10"><p>RPT token : https://docs.kantarainitiative.org/uma/rec-uma-core.html#rfc.section.3.5.1<a href="#fnref10">↩</a></p></li>
<li id="fn11"><p>Introspection endpoint : https://docs.kantarainitiative.org/uma/rec-uma-core.html#rfc.section.3.4.1<a href="#fnref11">↩</a></p></li>
<li id="fn12"><p>Liste des scopes : http://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims<a href="#fnref12">↩</a></p></li>
<li id="fn13"><p>DOTNET CORE : https://www.microsoft.com/net/core#windows<a href="#fnref13">↩</a></p></li>
</ol>
</div>
</body>
</html>
